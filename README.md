# Pipeline for calculating omic features required by F3UTER

This `snakemake` pipeline generate omic features for a set of input candidate regions. The omic features can be broadly categorised as either genomic or transcriptomic in nature. Features calculated from genomic data included poly(A) signal occurrence, DNA sequence conservation, mono-/di-nucleotide frequency, transposon occurrence and DNA structural properties. Features calculated from transcriptomic data included entropy efficiency of the mapped reads (EE) - a measure of the uniformity of read coverage over a genomic region, and percentage difference (a measure of the absolute difference) between the reads mapped at the boundaries (PD).

# Getting Started

## Input

- Regions of interest: Can be ERs (output of [Generate ERs](https://github.com/sid-sethi/Generate-ERs)) or a standard BED file. If a BED file, it must contain at least the following columns - `seqnames`, `start`, `end`, `strand` and `ER_id`. Please see `/test_data` for a demo file. Please note that contig names in BED file should be UCSC style: `chr1`, `chr2` .... `chrM`.
- Aligned RNA-seq reads in bigwig format to calculate the expression features. Multiple RNA-seq replicates can be provided. In case of multiple bigwigs, mean expression will be calculated. Please note that contig names in the bigwig should be Ensembl style: `1`, `2`.... `MT`.
- chromosome lengths are required by the code. A file containing chromosome lengths for hg38 is provided in `/data` and is automatically used by the pipeline.

External data resources:
- PhastCons scores from UCSC (bigwig format): https://hgdownload.soe.ucsc.edu/goldenPath/hg38/phastCons7way/hg38.phastCons7way.bw
- Repeats data from repeatmasker.org: http://www.repeatmasker.org/genomes/hg38/RepeatMasker-rm406-dfam2.0/hg38.fa.out.gz

Process the repeatmasker file using the commands below. Please see `/test_data` for a demo file.
```bash
gunzip hg38.fa.out.gz
awk -F " " '{print $5" "$6" "$7" "$11}' hg38.fa.out | sed 1d > hg38.repeatMasker.mod.fa.out
```
- DNA structural properties: data required to calculate DNA structural properties is included in `/data` and is automatically used by the pipeline. These tables were downloaded from http://bioinformatics.psb.ugent.be/webtools/ep3/?conversion.

## Output

The main output files generated by the pipeline are:

- `F3UTER_features/<sample_name>_nt_freq.txt` - mono- and di-nucleotide frequencies (n=20)
- `F3UTER_features/<sample_name>_phastcons.txt` - sequence conservation (phastCons) scores (n=1)
- `F3UTER_features/<sample_name>_polyA_signal.txt` - poly(A) signal occurrence (n=1; binary outcome)
- `F3UTER_features/<sample_name>_repeats.txt` - transposon occurrence (n=1)
- `F3UTER_features/<sample_name>_exp_feat.txt` - expression features (n=2)
- `F3UTER_features/<sample_name>_structural_feat.txt` - DNA structural properties (n=16)

## Depedencies

- [miniconda](https://conda.io/miniconda.html)
- [snakemake](http://snakemake.readthedocs.io/en/latest/) - can be installed via conda
- The rest of the dependencies (R packages) are installed via conda.

## Installation

Clone the pipeline:

```bash
git clone --recursive https://github.com/sid-sethi/Generate-F3UTER-features.git
```

## Usage

Edit `config.yml` to set up the working directory and input files. `Snakemake` command should be issued from within the pipeline directory.

```bash
cd Generate-F3UTER-features
snakemake --use-conda -j <num_cores> all
```
If you provide more than one core, independent snakemake rules will be processed simultaneously. This pipeline uses 6 cores at most. It is a good idea to do a dry run (using -n parameter) to view what would be done by the pipeline before executing the pipeline.

```bash
snakemake --use-conda -n all
```
Snakemake can be run to only install the required conda environments without running the full workflow. Subsequent runs with --use-conda will make use of the local environments without requiring internet access. This is suitable for running the pipeline offline.

```bash
snakemake --use-conda --conda-create-envs-only
```

## Licence

Copyright 2020 Astex Therapeutics Ltd.

This repository is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

This repository is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the [LICENSE](LICENSE) file (GNU General Public License) for more details.
